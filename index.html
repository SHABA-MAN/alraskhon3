<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة جداول الحفظ</title>
    
    <!-- استيراد Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- استيراد الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; overflow-x: hidden; }
        .font-serif { font-family: 'Amiri', serif; }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }

        /* --- تنسيق النص العمودي --- */
        .vertical-cell {
            position: relative;
            height: 100%;
            overflow: hidden;
        }
        .vertical-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            /* تم تعديل عرض النص قليلاً ليتناسب مع الارتفاع الجديد إذا لزم الأمر، لكن 540px مناسب */
            width: 540px; 
            text-align: center;
            white-space: pre-wrap;
            direction: rtl;
            line-height: 1.8;
        }

        /* --- تعديل حجم الورقة لتكون أقل عرضاً وأكثر تناسقاً --- */
        #pdfContent {
            /* تم تقليل العرض من 297mm إلى 250mm لتقليل العرض الزائد */
            width: 250mm !important;
            min-width: 250mm !important;
            min-height: 210mm !important;
            margin-left: auto;
            margin-right: auto;
            transform-origin: top center;
            transition: transform 0.2s ease;
        }

        /* --- زر الدعم العائم (InstaPay) --- */
        .fab-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 40; /* أقل من المودال */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6b21a8, #a855f7);
            box-shadow: 0 10px 25px -5px rgba(107, 33, 168, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }

        .fab-btn:hover {
            transform: translateY(-5px) scale(1.1) rotate(5deg);
            box-shadow: 0 20px 30px -10px rgba(107, 33, 168, 0.6);
        }
        
        .plane-icon { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* --- تنسيقات بطاقة الأنيميشن (3D Card) --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .card-scene {
            width: 320px;
            height: 200px;
            perspective: 1000px;
        }

        .card-object {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            transform: scale(0.8); /* يبدأ صغيراً */
            opacity: 0;
        }
        
        .modal-overlay.active .card-object {
            transform: scale(1);
            opacity: 1;
        }
        
        .modal-overlay.active .card-object.flipped {
            transform: rotateY(180deg) scale(1);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* يخفي الوجه الخلفي */
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        /* الوجه الأمامي (شعار انستا باي) */
        .card-front {
            background: linear-gradient(135deg, #4c1d95, #7e22ce);
            color: white;
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* الوجه الخلفي (الرسالة) */
        .card-back {
            background: white;
            transform: rotateY(180deg);
            color: #4c1d95;
            border: 4px solid #7e22ce;
        }

        /* دائرة التحميل */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e9d5ff;
            border-top-color: #7e22ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800 pb-24">

    <!-- --- نافذة الأنيميشن (Modal) --- -->
    <div id="instapayModal" class="modal-overlay">
        <div class="card-scene">
            <div id="cardObject" class="card-object">
                <!-- الوجه الأمامي -->
                <div class="card-face card-front">
                    <!-- شعار تقريبي لانستا باي -->
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-3">
                        <rect x="2" y="6" width="20" height="12" rx="2"/>
                        <circle cx="12" cy="12" r="2"/>
                        <path d="M6 12h.01M18 12h.01"/>
                    </svg>
                    <h3 class="text-2xl font-bold tracking-wider">InstaPay</h3>
                    <p class="text-sm opacity-80 mt-1">دعم آمن وسريع</p>
                </div>

                <!-- الوجه الخلفي -->
                <div class="card-face card-back">
                    <h3 class="text-lg font-bold mb-2">شكراً لدعمكم ❤️</h3>
                    <p class="text-sm text-slate-600 leading-relaxed">
                        سيتم تحويلك الآن لدعم مطور الموقع مادياً عبر تطبيق انستا باي..
                    </p>
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- --- الرأس --- -->
    <header class="bg-white shadow-sm border-b border-slate-100 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="logo.jpg" alt="شعار الموقع" class="w-12 h-12 rounded-full object-cover border border-emerald-100 bg-emerald-50">
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">منصة جداول الحفظ</h1>
                    <p class="text-xs text-emerald-600 font-medium flex items-center gap-1">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        هدية من فريق الراسخون
                    </p>
                </div>
            </div>
            
            <button onclick="downloadImage()" id="downloadBtn" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-full text-sm font-bold shadow-emerald-200 shadow-lg transition-all active:scale-95 disabled:opacity-50">
                <span class="hidden md:inline">تحميل صورة</span>
                <span class="md:hidden">تحميل</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </button>
        </div>
    </header>

    <!-- --- زر الدعم العائم (تم تعديله لفتح المودال) --- -->
    <div onclick="openInstaPayEffect()" class="fab-btn" title="دعم ب Instapay">
        <svg class="plane-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
    </div>

    <main class="max-w-6xl mx-auto p-4 md:p-8 gap-8 grid grid-cols-1 lg:grid-cols-12">
        
        <!-- --- قسم التعديل والأدوات --- -->
        <div class="lg:col-span-4 space-y-6 order-2 lg:order-1">
            
            <!-- بيانات الطالب -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <div class="w-2 h-6 bg-emerald-500 rounded-full"></div>
                    بيانات الطالب
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5">اسم الطالب</label>
                        <input type="text" id="inputName" oninput="updateData()" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 outline-none" value="عمرو">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1.5">عنوان الأسبوع</label>
                        <input type="text" id="inputWeek" oninput="updateData()" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 outline-none" value="الثاني">
                    </div>
                </div>
            </div>

            <!-- الأوراد الثابتة -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <div class="w-2 h-6 bg-blue-500 rounded-full"></div>
                    الأوراد الثابتة
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-blue-600 mb-1.5">الماضي البعيد</label>
                        <textarea id="inputFarPast" oninput="updateData()" rows="2" class="w-full px-3 py-2 bg-blue-50/50 border border-blue-100 rounded-xl focus:border-blue-400 outline-none text-sm">-</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-indigo-600 mb-1.5">الماضي القريب</label>
                        <textarea id="inputNearPast" oninput="updateData()" rows="2" class="w-full px-3 py-2 bg-indigo-50/50 border border-indigo-100 rounded-xl focus:border-indigo-400 outline-none text-sm">تسميع من أول سورة البقرة إلى آية ٢٥ يومياً</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-emerald-600 mb-1.5">التحضير</label>
                        <textarea id="inputPrep" oninput="updateData()" rows="3" class="w-full px-3 py-2 bg-emerald-50/50 border border-emerald-100 rounded-xl focus:border-emerald-400 outline-none text-sm">(( تلاوة ربع ))
(( أتأمرون الناس بالبر ))
والصلاة بالمحفوظ على مدار اليوم</textarea>
                    </div>
                </div>
            </div>

            <!-- الحفظ اليومي -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <div class="w-2 h-6 bg-amber-500 rounded-full"></div>
                    الحفظ اليومي
                </h2>
                <div id="rowsContainer" class="space-y-3 max-h-[400px] overflow-y-auto pr-1 scrollbar-thin"></div>
            </div>
        </div>

        <!-- --- قسم المعاينة (الورقة A4) --- -->
        <div class="lg:col-span-8 order-1 lg:order-2">
            <div id="previewContainer" class="bg-slate-200/50 rounded-3xl p-2 md:p-8 border border-slate-200/60 flex items-start justify-center overflow-hidden min-h-[300px]">
                
                <!-- الورقة نفسها -->
                <div id="pdfContent" class="bg-white shadow-xl relative box-border p-8 origin-top" style="font-family: 'Amiri', 'Cairo', serif;">
                    
                    <!-- رأس الجدول -->
                    <div class="flex items-center justify-between mb-6 border-b-2 border-double border-slate-100 pb-4">
                        <div class="text-right w-2/3">
                            <h2 class="text-4xl font-bold text-slate-800 mb-2">
                                الأسبوع <span id="previewWeek">الثاني</span>
                            </h2>
                            <div class="inline-block bg-emerald-50 px-4 py-1 rounded-full border border-emerald-100">
                                <span class="text-emerald-800 font-bold">الطالب: <span id="previewName">عمرو</span></span>
                            </div>
                        </div>
                        <div class="w-1/3 flex flex-col items-end justify-center">
                             <p class="text-base text-emerald-700 font-bold flex items-center gap-1 bg-emerald-50 px-4 py-2 rounded-lg border border-emerald-100/50">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                                هدية من فريق الراسخون
                             </p>
                        </div>
                    </div>

                    <!-- الجدول الرئيسي -->
                    <div class="w-full border-2 border-slate-800 rounded-lg overflow-hidden shadow-sm">
                        <!-- الترويسة -->
                        <div class="flex bg-emerald-50/80 border-b-2 border-slate-800 font-bold text-slate-800">
                            <div class="w-[10%] p-3 text-center border-l-2 border-slate-800">اليوم</div>
                            <div class="w-[15%] p-3 text-center border-l-2 border-slate-800">الماضي البعيد</div>
                            <div class="w-[25%] p-3 text-center border-l-2 border-slate-800">الماضي القريب</div>
                            <div class="w-[25%] p-3 text-center border-l-2 border-slate-800">الحفظ الجديد</div>
                            <div class="w-[25%] p-3 text-center">التحضير</div>
                        </div>

                        <!-- المحتوى -->
                        <div class="flex h-[550px]">
                            
                            <!-- 1. الأيام -->
                            <div class="w-[10%] flex flex-col border-l-2 border-slate-800 bg-slate-50/30" id="previewDaysCol"></div>

                            <!-- 2. الماضي البعيد -->
                            <div class="w-[15%] border-l-2 border-slate-800 bg-white vertical-cell">
                                <div id="previewFarPast" class="vertical-text font-bold text-2xl text-blue-900"></div>
                            </div>

                            <!-- 3. الماضي القريب -->
                            <div class="w-[25%] border-l-2 border-slate-800 bg-white vertical-cell">
                                 <div id="previewNearPast" class="vertical-text font-bold text-2xl text-indigo-900"></div>
                            </div>

                            <!-- 4. الحفظ الجديد -->
                            <div class="w-[25%] flex flex-col border-l-2 border-slate-800" id="previewNewHifzCol"></div>

                            <!-- 5. التحضير -->
                            <div class="w-[25%] bg-emerald-50/10 vertical-cell">
                                 <div id="previewPrep" class="vertical-text font-bold text-xl text-slate-800"></div>
                            </div>
                        </div>
                    </div>

                    <!-- التذييل -->
                    <div class="mt-4 flex justify-between items-end opacity-60">
                        <div class="text-xs text-slate-400">تم الإنشاء بواسطة منصة جداول الحفظ</div>
                        <div class="flex gap-1">
                            <div class="w-2 h-2 rounded-full bg-emerald-200"></div>
                            <div class="w-2 h-2 rounded-full bg-blue-200"></div>
                            <div class="w-2 h-2 rounded-full bg-indigo-200"></div>
                        </div>
                    </div>

                </div>
            </div>
            <p class="text-center text-xs text-slate-400 mt-2">يمكنك تكبير الشاشة لرؤية التفاصيل بوضوح</p>
        </div>
    </main>

    <script>
        // --- State & Data ---
        let appState = {
            studentName: 'عمرو',
            weekNumber: 'الثاني',
            farPast: '-',
            nearPast: 'تسميع من أول سورة البقرة إلى آية ٢٥ يومياً',
            preparation: '(( تلاوة ربع ))\n(( أتأمرون الناس بالبر ))\nوالصلاة بالمحفوظ على مدار اليوم',
            rows: [
                { day: 'السبت', type: 'range', from: '٢٦', to: '٢٨', text: '' },
                { day: 'الأحد', type: 'range', from: '٢٦', to: '٣٣', text: '' },
                { day: 'الاثنين', type: 'range', from: '٢٦', to: '٣٨', text: '' },
                { day: 'الثلاثاء', type: 'range', from: '٢٦', to: '٤٣', text: '' },
                { day: 'الأربعاء', type: 'text', from: '', to: '', text: 'تسميع الربع (٣) مرات' },
                { day: 'الخميس', type: 'text', from: '', to: '', text: 'تسميع الربع (٥) مرات' },
                { day: 'الجمعة', type: 'text', from: '', to: '', text: 'تسميع (٧) مرات' },
            ]
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderEditorRows();
            renderPreview();
            fitPreviewToScreen();
            window.addEventListener('resize', fitPreviewToScreen);
        });

        // --- InstaPay Animation Logic ---
        function openInstaPayEffect() {
            const modal = document.getElementById('instapayModal');
            const card = document.getElementById('cardObject');
            
            // 1. Show Modal Background
            modal.classList.add('active');
            
            // 2. Wait slightly then Flip the card
            setTimeout(() => {
                card.classList.add('flipped');
                
                // 3. Redirect after reading message
                setTimeout(() => {
                    window.location.href = 'https://ipn.eg/S/shaba1/instapay/0e3P4q';
                    
                    setTimeout(() => {
                        modal.classList.remove('active');
                        card.classList.remove('flipped');
                    }, 2000);
                }, 2500);
            }, 600);
        }

        // --- Core Functions ---
        function fitPreviewToScreen() {
            const container = document.getElementById('previewContainer');
            const content = document.getElementById('pdfContent');
            if (!container || !content) return;
            const contentWidth = content.offsetWidth; 
            const containerWidth = container.clientWidth - 20;
            let scale = containerWidth / contentWidth;
            if (scale > 1) scale = 1;
            content.style.transform = `scale(${scale})`;
            const scaledHeight = content.offsetHeight * scale;
            container.style.height = `${scaledHeight + 40}px`;
        }

        function updateData() {
            appState.studentName = document.getElementById('inputName').value;
            appState.weekNumber = document.getElementById('inputWeek').value;
            appState.farPast = document.getElementById('inputFarPast').value;
            appState.nearPast = document.getElementById('inputNearPast').value;
            appState.preparation = document.getElementById('inputPrep').value;
            renderPreview();
        }

        function updateRow(index, field, value) {
            appState.rows[index][field] = value;
            renderPreview();
        }

        function toggleRowType(index, type) {
            appState.rows[index].type = type;
            renderEditorRows();
            renderPreview();
        }

        function renderEditorRows() {
            const container = document.getElementById('rowsContainer');
            container.innerHTML = '';

            appState.rows.forEach((row, index) => {
                const div = document.createElement('div');
                div.className = 'bg-slate-50 p-3 rounded-xl border border-slate-100 transition-all hover:border-sky-200';
                const rangeBtnClass = row.type === 'range' ? 'bg-emerald-100 text-emerald-700' : 'text-slate-400 hover:text-slate-600';
                const textBtnClass = row.type === 'text' ? 'bg-emerald-100 text-emerald-700' : 'text-slate-400 hover:text-slate-600';

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-slate-700 text-sm">${row.day}</span>
                        <div class="flex bg-white rounded-lg border border-slate-200 p-0.5 shadow-sm">
                            <button onclick="toggleRowType(${index}, 'range')" class="px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1 transition-colors ${rangeBtnClass}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>
                            </button>
                            <button onclick="toggleRowType(${index}, 'text')" class="px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1 transition-colors ${textBtnClass}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>
                            </button>
                        </div>
                    </div>
                `;

                if (row.type === 'range') {
                    div.innerHTML += `
                        <div class="flex items-center gap-2">
                            <input type="text" value="${row.from || ''}" oninput="updateRow(${index}, 'from', this.value)" class="w-full p-1.5 bg-white border border-slate-200 rounded-lg text-center text-sm focus:border-emerald-400 outline-none" placeholder="من">
                            <svg class="text-slate-300" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                            <input type="text" value="${row.to || ''}" oninput="updateRow(${index}, 'to', this.value)" class="w-full p-1.5 bg-white border border-slate-200 rounded-lg text-center text-sm focus:border-emerald-400 outline-none" placeholder="إلى">
                        </div>
                    `;
                } else {
                    div.innerHTML += `
                        <input type="text" value="${row.text || ''}" oninput="updateRow(${index}, 'text', this.value)" class="w-full p-1.5 bg-white border border-slate-200 rounded-lg text-sm focus:border-emerald-400 outline-none" placeholder="نص الورد...">
                    `;
                }
                container.appendChild(div);
            });
        }

        function downloadImage() {
            const element = document.getElementById('pdfContent');
            const btn = document.getElementById('downloadBtn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<span class="animate-pulse">جاري المعالجة...</span>';
            
            // 1. Reset Scale for High Quality Capture
            const currentTransform = element.style.transform;
            element.style.transform = 'scale(1)';
            
            setTimeout(async () => {
                try {
                    await document.fonts.ready;

                    // 2. RASTERIZE VERTICAL TEXT (Fix for iOS/Arabic Rotation Issue)
                    const verticalElements = element.querySelectorAll('.vertical-text');
                    const swaps = [];

                    // Convert each vertical text to an image horizontally first
                    for (let el of verticalElements) {
                        // Create a temporary horizontal clone
                        const clone = el.cloneNode(true);
                        clone.style.transform = 'none'; // Remove rotation
                        clone.style.position = 'fixed';
                        clone.style.top = '-9999px';
                        clone.style.left = '-9999px';
                        clone.style.width = '540px'; // Keep original width
                        clone.style.height = 'auto';
                        clone.style.textAlign = 'center';
                        clone.style.background = 'transparent';
                        clone.className = 'text-2xl font-bold leading-relaxed'; // Ensure styling matches
                        // Explicitly set color if needed, or let it inherit
                        
                        document.body.appendChild(clone);

                        // Capture text as image
                        const textCanvas = await html2canvas(clone, {
                            backgroundColor: null,
                            scale: 2
                        });
                        
                        document.body.removeChild(clone);

                        // Save original state
                        swaps.push({ el, oldHTML: el.innerHTML });

                        // Replace text with image
                        const img = document.createElement('img');
                        img.src = textCanvas.toDataURL();
                        img.style.width = '100%';
                        img.style.height = 'auto';
                        
                        el.innerHTML = '';
                        el.appendChild(img);
                    }

                    // 3. Capture the Main Table (now with images instead of rotated text)
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        scrollY: -window.scrollY,
                        allowTaint: true,
                        logging: false,
                        width: element.offsetWidth,
                        height: element.offsetHeight
                    });

                    // 4. Download
                    const link = document.createElement('a');
                    link.download = `جدول_الحفظ_${appState.weekNumber}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.95);
                    link.click();

                    // 5. Restore Original Text
                    swaps.forEach(s => s.el.innerHTML = s.oldHTML);

                } catch (err) {
                    console.error("Error:", err);
                    alert("حدث خطأ أثناء إنشاء الصورة.");
                } finally {
                    // Restore UI
                    element.style.transform = currentTransform;
                    btn.innerHTML = originalText;
                }
            }, 100);
        }
    </script>
</body>
</html>