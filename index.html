<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة جداول الحفظ</title>
    
    <!-- استيراد Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- استيراد الخطوط (تم إضافة Tajawal حسب الثيم الجديد) -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Tajawal:wght@400;500;700;800&family=Cairo:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- متغيرات الثيم الجديد --- */
        :root {
            --primary-gold: #c5a059;
            --primary-dark: #1a3c34;
            --primary-cream: #f9f7f2;
            --accent-wood: #5d4037;
        }

        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #f0ebe0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c5a059' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            overflow-x: hidden; 
        }
        
        .font-serif { font-family: 'Amiri', serif; }
        .historical-font { font-family: 'Amiri', serif; }

        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: var(--primary-gold); border-radius: 20px; }

        /* --- تأثيرات الثيم --- */
        .golden-gradient {
            background: linear-gradient(135deg, #b8860b 0%, #eec96d 50%, #b8860b 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 30px -10px rgba(26, 60, 52, 0.15);
        }

        /* --- تنسيق النص العمودي --- */
        .vertical-cell {
            position: relative;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .vertical-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            width: 540px; 
            text-align: center;
            white-space: pre-wrap;
            direction: rtl;
            line-height: 1.8;
            text-rendering: geometricPrecision;
        }

        /* --- حجم الورقة --- */
        #pdfContent {
            width: 250mm !important;
            min-width: 250mm !important;
            min-height: 210mm !important;
            margin-left: auto;
            margin-right: auto;
            transform-origin: top center;
            transition: transform 0.2s ease;
        }

        /* --- زر الدعم العائم --- */
        .fab-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 40;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            /* تحديث لون الزر ليتناسب مع الثيم (بنفسجي غامق يتماشى مع انستا باي) */
            background: linear-gradient(135deg, #4c1d95, #6d28d9);
            box-shadow: 0 10px 25px -5px rgba(76, 29, 149, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }
        .fab-btn:hover {
            transform: translateY(-5px) scale(1.1) rotate(5deg);
            box-shadow: 0 20px 30px -10px rgba(76, 29, 149, 0.6);
        }
        .plane-icon { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* --- تنسيقات المودال --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(26, 60, 52, 0.8); /* خلفية زيتي غامق شفاف */
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .card-scene { width: 320px; height: 200px; perspective: 1000px; }
        .card-object {
            width: 100%; height: 100%; position: relative;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d; transform: scale(0.8); opacity: 0;
        }
        .modal-overlay.active .card-object { transform: scale(1); opacity: 1; }
        .modal-overlay.active .card-object.flipped { transform: rotateY(180deg) scale(1); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; text-align: center;
        }
        .card-front { background: linear-gradient(135deg, #4c1d95, #7e22ce); color: white; border: 2px solid rgba(255,255,255,0.2); }
        .card-back { background: #fffdf9; transform: rotateY(180deg); color: #4c1d95; border: 4px solid #7e22ce; }
        .spinner {
            width: 24px; height: 24px; border: 3px solid #e9d5ff; border-top-color: #7e22ce;
            border-radius: 50%; animation: spin 1s linear infinite; margin-top: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* AI Box Styles - Themed */
        .ai-box {
            background: linear-gradient(135deg, #f0ebe0 0%, #fffdf9 100%);
            border: 1px solid rgba(197, 160, 89, 0.3);
        }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- Modal -->
    <div id="instapayModal" class="modal-overlay">
        <div class="card-scene">
            <div id="cardObject" class="card-object">
                <div class="card-face card-front">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-3">
                        <rect x="2" y="6" width="20" height="12" rx="2"/>
                        <circle cx="12" cy="12" r="2"/>
                        <path d="M6 12h.01M18 12h.01"/>
                    </svg>
                    <h3 class="text-2xl font-bold tracking-wider">InstaPay</h3>
                    <p class="text-sm opacity-80 mt-1">دعم آمن وسريع</p>
                </div>
                <div class="card-face card-back">
                    <h3 class="text-lg font-bold mb-2">شكراً لدعمكم ❤️</h3>
                    <p class="text-sm text-slate-600 leading-relaxed">سيتم تحويلك الآن لدعم مطور الموقع مادياً عبر تطبيق انستا باي..</p>
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Themed -->
    <header class="bg-[#1a3c34] text-[#f9f7f2] sticky top-0 z-50 shadow-lg border-b-4 border-[#c5a059]">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between relative overflow-hidden">
            <!-- زخرفة خلفية الهيدر -->
            <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;"></div>
            
            <div class="flex items-center gap-3 relative z-10">
                <div class="relative">
                    <img src="/logo.jpg" onerror="this.src='https://via.placeholder.com/150/1a3c34/c5a059?text=Quran'" alt="شعار الموقع" class="w-14 h-14 rounded-full border-2 border-[#c5a059] shadow-md object-cover bg-white p-0.5">
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight text-[#eec96d] historical-font">منصة جداول الحفظ</h1>
                    <p class="text-xs text-emerald-100/80 font-light flex items-center gap-1">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        هدية من فريق الجبال الرواسي
                    </p>
                </div>
            </div>
            
            <button onclick="downloadImage()" id="downloadBtn" class="flex items-center gap-2 bg-[#0f2420] hover:bg-[#2c584e] text-[#c5a059] px-5 py-2 rounded-full text-sm font-bold shadow-lg transition border border-[#c5a059]/30 relative z-10 active:scale-95 disabled:opacity-50">
                <span class="hidden md:inline">تحميل صورة</span>
                <span class="md:hidden">تحميل</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            </button>
        </div>
    </header>

    <div onclick="openInstaPayEffect()" class="fab-btn" title="دعم ب Instapay">
        <svg class="plane-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </div>

    <main class="max-w-6xl mx-auto p-4 md:p-8 gap-8 grid grid-cols-1 lg:grid-cols-12">
        <!-- Editor Section -->
        <div class="lg:col-span-4 space-y-6 order-2 lg:order-1">
            
            <!-- قسم التبديل الذكي -->
            <div class="ai-box p-5 rounded-2xl shadow-sm relative overflow-hidden card-shadow">
                <div class="flex items-center gap-2 mb-3 text-[#1a3c34] font-bold">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
                    ترتيب الأيام (ذكي)
                </div>
                
                <div class="relative">
                    <input type="text" id="aiInput" onkeydown="if(event.key === 'Enter') smartReorder()" class="w-full px-4 py-2.5 pl-10 bg-[#fffdf9] border border-[#c5a059]/30 rounded-xl focus:ring-1 focus:ring-[#c5a059] focus:border-[#c5a059] outline-none text-sm text-[#1a3c34] placeholder-gray-400" placeholder="مثال: ابدأ بـ يوم الأحد">
                    <button onclick="smartReorder()" id="aiBtn" class="absolute left-1.5 top-1.5 p-1.5 bg-[#c5a059] hover:bg-[#b8860b] text-[#1a3c34] rounded-lg transition-colors shadow-sm">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </div>
                <p id="aiStatus" class="text-[10px] text-[#5d4037] mt-2 h-4"></p>
            </div>

            <!-- Card: Student Data -->
            <div class="bg-[#fffdf9] p-6 rounded-2xl shadow-sm border border-[#c5a059]/30 card-shadow">
                <h2 class="text-lg font-bold text-[#1a3c34] mb-4 flex items-center gap-2 historical-font">
                    <div class="w-1.5 h-6 bg-[#c5a059] rounded-full"></div>
                    بيانات الطالب
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-[#5d4037] mb-1.5">اسم الطالب</label>
                        <input type="text" id="inputName" oninput="updateData()" class="w-full px-4 py-2.5 bg-[#f9f7f2] border border-[#d1d5db] rounded-xl focus:ring-1 focus:ring-[#c5a059] focus:border-[#c5a059] outline-none text-[#1a3c34]" value="عمرو">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#5d4037] mb-1.5">رقم المجموعة</label>
                        <input type="text" id="inputGroup" oninput="updateData()" class="w-full px-4 py-2.5 bg-[#f9f7f2] border border-[#d1d5db] rounded-xl focus:ring-1 focus:ring-[#c5a059] focus:border-[#c5a059] outline-none text-[#1a3c34]" value="1">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#5d4037] mb-1.5">عنوان الأسبوع</label>
                        <input type="text" id="inputWeek" oninput="updateData()" class="w-full px-4 py-2.5 bg-[#f9f7f2] border border-[#d1d5db] rounded-xl focus:ring-1 focus:ring-[#c5a059] focus:border-[#c5a059] outline-none text-[#1a3c34]" value="الثاني">
                    </div>
                </div>
            </div>

            <!-- Card: Fixed Wird -->
            <div class="bg-[#fffdf9] p-6 rounded-2xl shadow-sm border border-[#c5a059]/30 card-shadow">
                <h2 class="text-lg font-bold text-[#1a3c34] mb-4 flex items-center gap-2 historical-font">
                    <div class="w-1.5 h-6 bg-[#1a3c34] rounded-full"></div>
                    الأوراد الثابتة
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-[#5d4037] mb-1.5">الماضي البعيد</label>
                        <textarea id="inputFarPast" oninput="updateData()" rows="2" class="w-full px-3 py-2 bg-[#f9f7f2] border border-[#d1d5db] rounded-xl focus:border-[#1a3c34] outline-none text-sm text-[#1a3c34]">-</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#5d4037] mb-1.5">الماضي القريب</label>
                        <textarea id="inputNearPast" oninput="updateData()" rows="2" class="w-full px-3 py-2 bg-[#f9f7f2] border border-[#d1d5db] rounded-xl focus:border-[#1a3c34] outline-none text-sm text-[#1a3c34]">تسميع من أول سورة البقرة إلى آية ٢٥ يومياً</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-[#5d4037] mb-1.5">التحضير</label>
                        <textarea id="inputPrep" oninput="updateData()" rows="3" class="w-full px-3 py-2 bg-[#f9f7f2] border border-[#d1d5db] rounded-xl focus:border-[#1a3c34] outline-none text-sm text-[#1a3c34]">(( تلاوة ربع ))
(( أتأمرون الناس بالبر ))
والصلاة بالمحفوظ على مدار اليوم</textarea>
                    </div>
                </div>
            </div>

            <!-- Daily Hifz -->
            <div class="bg-[#fffdf9] p-6 rounded-2xl shadow-sm border border-[#c5a059]/30 card-shadow">
                <h2 class="text-lg font-bold text-[#1a3c34] mb-4 flex items-center gap-2 historical-font">
                    <div class="w-1.5 h-6 bg-[#c5a059] rounded-full"></div>
                    الحفظ اليومي
                </h2>
                <div id="rowsContainer" class="space-y-3 max-h-[400px] overflow-y-auto pr-1 scrollbar-thin"></div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="lg:col-span-8 order-1 lg:order-2">
            <!-- Preview Container -->
            <div id="previewContainer" class="bg-[#e6e2d3] rounded-3xl p-2 md:p-8 border-2 border-[#c5a059]/20 flex items-start justify-center overflow-hidden min-h-[300px] shadow-inner">
                
                <div id="pdfContent" class="bg-white shadow-2xl relative box-border p-8 origin-top" style="font-family: 'Amiri', 'Cairo', serif;">
                    
                    <!-- ترويسة الجدول -->
                    <div class="flex items-start justify-between mb-6 border-b-2 border-double border-[#c5a059]/30 pb-4">
                        <div class="text-right w-1/2 pt-2">
                            <h2 class="text-5xl font-bold text-[#1a3c34] mb-2 leading-tight historical-font">
                                الأسبوع <span id="previewWeek" class="text-[#c5a059]">الثاني</span>
                            </h2>
                        </div>
                        <div class="w-1/2 flex flex-col items-end gap-2">
                            <!-- بطاقة الاسم في المعاينة -->
                            <div class="bg-[#fffdf9] border-2 border-[#c5a059] rounded-xl px-6 py-3 shadow-sm w-fit min-w-[200px] relative overflow-hidden group">
                                <div class="absolute top-0 right-0 w-1.5 h-full bg-[#1a3c34]"></div>
                                <div class="flex items-center justify-between gap-4 mb-2 border-b border-[#c5a059]/20 pb-2">
                                    <span class="text-xs font-bold text-[#5d4037]">الطالب</span>
                                    <span id="previewName" class="text-lg font-bold text-[#1a3c34]">عمرو</span>
                                </div>
                                <div class="flex items-center justify-between gap-4">
                                    <span class="text-xs font-bold text-[#5d4037]">المجموعة</span>
                                    <span id="previewGroup" class="text-lg font-bold font-serif text-[#c5a059]">1</span>
                                </div>
                            </div>
                            <p class="text-[10px] text-[#1a3c34] font-medium flex items-center gap-1 opacity-80 pl-1">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5 4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                                هدية من فريق الراسخون
                            </p>
                        </div>
                    </div>

                    <!-- الجدول الرئيسي -->
                    <div class="w-full border-2 border-[#1a3c34] rounded-lg overflow-hidden shadow-sm">
                        <!-- ترويسة الجدول -->
                        <div class="flex bg-[#1a3c34] border-b-2 border-[#1a3c34] font-extrabold text-[#f9f7f2] text-2xl">
                            <div class="w-[10%] p-3 text-center border-l-2 border-[#c5a059]">اليوم</div>
                            <div class="w-[15%] p-3 text-center border-l-2 border-[#c5a059]">الماضي البعيد</div>
                            <div class="w-[25%] p-3 text-center border-l-2 border-[#c5a059]">الماضي القريب</div>
                            <div class="w-[25%] p-3 text-center border-l-2 border-[#c5a059]">الحفظ الجديد</div>
                            <div class="w-[25%] p-3 text-center">التحضير</div>
                        </div>

                        <div class="flex h-[550px]">
                            <!-- عمود الأيام -->
                            <div class="w-[10%] flex flex-col border-l-2 border-[#1a3c34] bg-[#f0ebe0] font-bold text-2xl text-[#1a3c34]" id="previewDaysCol"></div>

                            <!-- الماضي البعيد -->
                            <div class="w-[15%] border-l-2 border-[#1a3c34] bg-white vertical-cell">
                                <div id="previewFarPast" class="vertical-text font-bold text-2xl text-[#1a3c34]" data-color="#1a3c34"></div>
                            </div>

                            <!-- الماضي القريب -->
                            <div class="w-[25%] border-l-2 border-[#1a3c34] bg-white vertical-cell">
                                 <div id="previewNearPast" class="vertical-text font-bold text-2xl text-[#5d4037]" data-color="#5d4037"></div>
                            </div>

                            <!-- الحفظ الجديد -->
                            <div class="w-[25%] flex flex-col border-l-2 border-[#1a3c34]" id="previewNewHifzCol"></div>

                            <!-- التحضير -->
                            <div class="w-[25%] bg-[#fffcf5] vertical-cell">
                                 <div id="previewPrep" class="vertical-text font-bold text-xl text-[#1a3c34]" data-color="#1a3c34"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-between items-end opacity-60">
                        <div class="text-xs text-[#5d4037]">تم الإنشاء بواسطة منصة جداول الحفظ</div>
                        <div class="flex gap-1">
                            <div class="w-2 h-2 rounded-full bg-[#c5a059]"></div>
                            <div class="w-2 h-2 rounded-full bg-[#1a3c34]"></div>
                            <div class="w-2 h-2 rounded-full bg-[#5d4037]"></div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-center text-xs text-[#5d4037] mt-2">يمكنك تكبير الشاشة لرؤية التفاصيل بوضوح</p>
        </div>
    </main>

    <script>
        let appState = {
            studentName: 'عمرو',
            groupNumber: '1',
            weekNumber: 'الثاني',
            farPast: '-',
            nearPast: 'تسميع من أول سورة البقرة إلى آية ٢٥ يومياً',
            preparation: '(( تلاوة ربع ))\n(( أتأمرون الناس بالبر ))\nوالصلاة بالمحفوظ على مدار اليوم',
            rows: [
                { day: 'الجمعة', type: 'range', surah: 'البقرة', from: '٢٦', to: '٢٨', text: '' },
                { day: 'السبت', type: 'range', surah: 'البقرة', from: '٢٦', to: '٣٣', text: '' },
                { day: 'الأحد', type: 'range', surah: 'البقرة', from: '٢٦', to: '٣٨', text: '' },
                { day: 'الاثنين', type: 'range', surah: 'البقرة', from: '٢٦', to: '٤٣', text: '' },
                { day: 'الثلاثاء', type: 'text', from: '', to: '', text: 'تسميع الربع (٣) مرات' },
                { day: 'الأربعاء', type: 'text', from: '', to: '', text: 'تسميع الربع (٥) مرات' },
                { day: 'الخميس', type: 'text', from: '', to: '', text: 'تسميع الربع (٧) مرات' },
            ]
        };

        const daysOfWeek = ['السبت', 'الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];

        document.addEventListener('DOMContentLoaded', () => {
            renderEditorRows();
            renderPreview();
            fitPreviewToScreen();
            window.addEventListener('resize', fitPreviewToScreen);
        });

        // --- Smart Reorder (LOCAL - No API Key) ---
        function smartReorder() {
            const input = document.getElementById('aiInput').value;
            const status = document.getElementById('aiStatus');
            
            if (!input) return;

            let foundDay = null;
            for (const day of daysOfWeek) {
                if (input.includes(day)) {
                    foundDay = day;
                    break;
                }
            }

            if (foundDay) {
                reorderDays(foundDay);
                status.innerText = `تم تعديل البداية إلى: ${foundDay}`;
                status.className = "text-[10px] text-[#1a3c34] mt-2 h-4 font-bold";
            } else {
                status.innerText = 'لم أتمكن من فهم اليوم، يرجى كتابته بوضوح (مثلاً: السبت)';
                status.className = "text-[10px] text-red-600 mt-2 h-4";
            }
        }

        function reorderDays(startDay) {
            const startIndex = daysOfWeek.indexOf(startDay);
            if (startIndex === -1) return;

            const newOrder = [
                ...daysOfWeek.slice(startIndex),
                ...daysOfWeek.slice(0, startIndex)
            ];

            appState.rows.forEach((row, index) => {
                row.day = newOrder[index];
            });

            renderEditorRows();
            renderPreview();
        }

        function openInstaPayEffect() {
            const modal = document.getElementById('instapayModal');
            const card = document.getElementById('cardObject');
            modal.classList.add('active');
            setTimeout(() => {
                card.classList.add('flipped');
                setTimeout(() => {
                    window.location.href = 'https://ipn.eg/S/shaba1/instapay/0e3P4q';
                    setTimeout(() => {
                        modal.classList.remove('active');
                        card.classList.remove('flipped');
                    }, 2000);
                }, 2500);
            }, 600);
        }

        function fitPreviewToScreen() {
            const container = document.getElementById('previewContainer');
            const content = document.getElementById('pdfContent');
            if (!container || !content) return;
            const contentWidth = content.offsetWidth; 
            const containerWidth = container.clientWidth - 20;
            let scale = containerWidth / contentWidth;
            if (scale > 1) scale = 1;
            content.style.transform = `scale(${scale})`;
            const scaledHeight = content.offsetHeight * scale;
            container.style.height = `${scaledHeight + 40}px`;
        }

        function updateData() {
            appState.studentName = document.getElementById('inputName').value;
            appState.groupNumber = document.getElementById('inputGroup').value;
            appState.weekNumber = document.getElementById('inputWeek').value;
            appState.farPast = document.getElementById('inputFarPast').value;
            appState.nearPast = document.getElementById('inputNearPast').value;
            appState.preparation = document.getElementById('inputPrep').value;
            renderPreview();
        }

        function updateRow(index, field, value) {
            appState.rows[index][field] = value;
            renderPreview();
        }

        function toggleRowType(index, type) {
            appState.rows[index].type = type;
            renderEditorRows();
            renderPreview();
        }

        function renderEditorRows() {
            const container = document.getElementById('rowsContainer');
            container.innerHTML = '';
            appState.rows.forEach((row, index) => {
                const div = document.createElement('div');
                div.className = 'bg-[#fffdf9] p-3 rounded-xl border border-[#c5a059]/20 transition-all hover:border-[#c5a059]';
                const rangeBtnClass = row.type === 'range' ? 'bg-[#1a3c34] text-[#c5a059]' : 'text-gray-400 hover:text-[#1a3c34]';
                const textBtnClass = row.type === 'text' ? 'bg-[#1a3c34] text-[#c5a059]' : 'text-gray-400 hover:text-[#1a3c34]';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-[#1a3c34] text-sm">${row.day}</span>
                        <div class="flex bg-white rounded-lg border border-[#d1d5db] p-0.5 shadow-sm">
                            <button onclick="toggleRowType(${index}, 'range')" class="px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1 transition-colors ${rangeBtnClass}"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg></button>
                            <button onclick="toggleRowType(${index}, 'text')" class="px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1 transition-colors ${textBtnClass}"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg></button>
                        </div>
                    </div>
                `;
                if (row.type === 'range') {
                    div.innerHTML += `
                        <div class="flex flex-col gap-2">
                            <input type="text" value="${row.surah || ''}" oninput="updateRow(${index}, 'surah', this.value)" class="w-full p-1.5 bg-[#f9f7f2] border border-[#d1d5db] rounded-lg text-sm focus:border-[#c5a059] outline-none" placeholder="اسم السورة (اختياري)">
                            <div class="flex items-center gap-2">
                                <input type="text" value="${row.from || ''}" oninput="updateRow(${index}, 'from', this.value)" class="w-full p-1.5 bg-[#f9f7f2] border border-[#d1d5db] rounded-lg text-center text-sm focus:border-[#c5a059] outline-none" placeholder="من">
                                <svg class="text-[#c5a059]" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                                <input type="text" value="${row.to || ''}" oninput="updateRow(${index}, 'to', this.value)" class="w-full p-1.5 bg-[#f9f7f2] border border-[#d1d5db] rounded-lg text-center text-sm focus:border-[#c5a059] outline-none" placeholder="إلى">
                            </div>
                        </div>`;
                } else {
                    div.innerHTML += `<input type="text" value="${row.text || ''}" oninput="updateRow(${index}, 'text', this.value)" class="w-full p-1.5 bg-[#f9f7f2] border border-[#d1d5db] rounded-lg text-sm focus:border-[#c5a059] outline-none" placeholder="نص الورد...">`;
                }
                container.appendChild(div);
            });
        }

        function renderPreview() {
            document.getElementById('previewName').innerText = appState.studentName;
            document.getElementById('previewGroup').innerText = appState.groupNumber;
            document.getElementById('previewWeek').innerText = appState.weekNumber;
            
            const farPastEl = document.getElementById('previewFarPast');
            farPastEl.innerText = appState.farPast;
            farPastEl.setAttribute('data-text', appState.farPast);

            const nearPastEl = document.getElementById('previewNearPast');
            nearPastEl.innerText = appState.nearPast;
            nearPastEl.setAttribute('data-text', appState.nearPast);

            const prepEl = document.getElementById('previewPrep');
            prepEl.innerText = appState.preparation;
            prepEl.setAttribute('data-text', appState.preparation);

            const daysCol = document.getElementById('previewDaysCol');
            const hifzCol = document.getElementById('previewNewHifzCol');
            daysCol.innerHTML = '';
            hifzCol.innerHTML = '';

            appState.rows.forEach(row => {
                // Update day colors to match theme
                daysCol.innerHTML += `<div class="flex-1 flex items-center justify-center border-b border-[#c5a059]/30 last:border-b-0 font-bold text-2xl text-[#1a3c34]">${row.day}</div>`;
                let content = '';
                if (row.type === 'range') {
                    const surahHtml = row.surah ? `<span class="block text-[#1a3c34] text-sm font-bold mb-1 font-serif">سورة ${row.surah}</span>` : '';
                    content = `
                        <div class="flex flex-col items-center justify-center w-full">
                            ${surahHtml}
                            <div class="flex items-center gap-3 text-[#c5a059] text-2xl font-bold dir-ltr">
                                <span class="w-10 text-center font-serif text-[#1a3c34]">${row.from || '?'}</span>
                                <span class="text-[#c5a059] text-xl">←</span>
                                <span class="w-10 text-center font-serif text-[#1a3c34]">${row.to || '?'}</span>
                            </div>
                        </div>`;
                } else {
                    content = `<span class="font-bold text-[#1a3c34] text-xl leading-tight">${row.text || ''}</span>`;
                }
                hifzCol.innerHTML += `<div class="flex-1 flex items-center justify-center text-center border-b border-[#c5a059]/30 last:border-b-0 p-1 bg-white">${content}</div>`;
            });
        }

        // --- Drawing Logic (Updated Font) ---
        function drawVerticalText(text, color) {
            if (!text) return null;
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            const width = 540; const height = 250;
            tempCanvas.width = width; tempCanvas.height = height;
            // Updated font to 'Tajawal' to match the new theme
            ctx.direction = 'rtl'; ctx.font = 'bold 24px "Tajawal", sans-serif'; ctx.fillStyle = color;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            const lines = text.split('\n'); const lineHeight = 45;
            const startY = (height - ((lines.length - 1) * lineHeight)) / 2;
            lines.forEach((line, i) => { ctx.fillText(line, width / 2, startY + (i * lineHeight)); });
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = height; finalCanvas.height = width;
            const fCtx = finalCanvas.getContext('2d');
            fCtx.translate(0, width); fCtx.rotate(-Math.PI / 2); fCtx.drawImage(tempCanvas, 0, 0);
            return finalCanvas.toDataURL();
        }

        async function downloadImage() {
            const element = document.getElementById('pdfContent');
            const btn = document.getElementById('downloadBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">جاري المعالجة...</span>';
            btn.disabled = true;
            const currentTransform = element.style.transform;
            element.style.transform = 'scale(1)';
            try {
                await document.fonts.ready;
                const verticalElements = document.querySelectorAll('.vertical-text');
                const restoreTasks = [];
                verticalElements.forEach(el => {
                    const text = el.getAttribute('data-text') || el.innerText;
                    // Pass color explicitly if needed, currently using data attributes in HTML
                    const color = el.getAttribute('data-color') || '#1a3c34';
                    const dataUrl = drawVerticalText(text, color);
                    if (dataUrl) {
                        const originalHTML = el.innerHTML;
                        const img = document.createElement('img');
                        img.src = dataUrl;
                        el.classList.remove('vertical-text');
                        el.style.position = 'absolute'; el.style.top = '0'; el.style.left = '0';
                        el.style.width = '100%'; el.style.height = '100%';
                        el.style.display = 'flex'; el.style.alignItems = 'center'; el.style.justifyContent = 'center';
                        el.style.transform = 'none';
                        el.innerHTML = ''; el.appendChild(img);
                        restoreTasks.push(() => {
                            el.innerHTML = originalHTML; el.classList.add('vertical-text');
                            el.removeAttribute('style');
                        });
                    }
                });
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: '#f0ebe0', scrollY: -window.scrollY, logging: false, width: element.offsetWidth, height: element.offsetHeight });
                const link = document.createElement('a');
                link.download = `جدول_الحفظ_${appState.weekNumber}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
                restoreTasks.forEach(t => t());
            } catch (err) { console.error(err); alert("حدث خطأ أثناء إنشاء الصورة."); } 
            finally { element.style.transform = currentTransform; btn.innerHTML = originalText; btn.disabled = false; }
        }
    </script>
</body>
</html>